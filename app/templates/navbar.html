<link rel="stylesheet" href="{{ url_for('static', filename='navbar.css') }}">

<div class="navbar">
    <!-- Logo, lleva a la pÃ¡gina principal -->
    <a class="logo" href="{{ url_for('home.home') }}">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="MiTrÃ¡mite Logo" class="logo-img">
    </a>
    <!-- BÃºsqueda -->
    <div class="search-container">
        <input type="text" placeholder="Buscar Beneficio..." id="busquedaBeneficios" autocomplete="off">
            <div id="resultadosBusqueda" class="resultadosBusqueda"></div>
    </div>

    <!-- Ãconos -->
    <div class="icons">
        <button class="icon-btn perfil-icon" title="Perfil">ðŸ‘¤</button>
        {% if session.get('nombre') %}
        <button class="icon-btn tracking-btn" title="Notificaciones">ðŸ””
            {% if g.notificaciones_usuario and g.notificaciones_usuario|length > 0 %}
                <span class="badge">{{ g.notificaciones_usuario|length }}</span>
            {% endif %}
            </button>
        <button class="icon-btn tracking-btn" title="TrÃ¡mites">
            ðŸ“‹
            {% if g.beneficios_usuario and g.beneficios_usuario|length > 0 %}
                <span class="badge">{{ g.beneficios_usuario|length }}</span>
            {% endif %}
        {% endif %}
        </button>
    </div>
</div>

<!-- MenÃº desplegable del perfil -->
 
<div id="perfil-menu" class="perfil-menu">
    {% if session.get('nombre') %}
    <div class="perfil-header">
        Bienvenido, <strong>{{ session.get('nombre', 'Usuario') }}</strong>
    </div>
    <a href="{{ url_for('auth.logout') }}">Cerrar sesiÃ³n</a>
    {% else %}
    <div class="perfil-header">
        Â¡Hola, <strong>Invitado!</strong>
    </div>
    <a href="{{ url_for('auth.printScreen') }}">Â¡Create una Cuenta!</a>
    {% endif %}
 
</div>

<!-- MenÃº desplegable de notificaciones -->
<div id="notificaciones-menu" class="notificaciones-menu">
    <div class="notificaciones-header">
        <strong>Notificaciones</strong>
    </div>

    {% if g.notificaciones_usuario and g.notificaciones_usuario|length > 0 %}
        {% for n in g.notificaciones_usuario %}
            <div class="notificacion-item" data-id="{{ n.id }}">
                <span class="mensaje">{{ n.mensaje }}</span>
                
                <!-- BotÃ³n X -->
                <button class="btn-eliminar-notificacion" data-id="{{ n.id }}">
                    âœ–
                </button>
            </div>
        {% endfor %}
    {% else %}
        <div class="notificaciones-item sin">
            No tienes notificaciones.
        </div>
    {% endif %}
</div>


<!-- MenÃº desplegable de beneficios en seguimiento -->
<div id="seguimiento-menu" class="seguimiento-menu">
    <div class="seguimiento-header">
        <strong>En seguimiento</strong>
    </div>

    {% if g.beneficios_usuario and g.beneficios_usuario|length > 0 %}
        {% for b in g.beneficios_usuario %}
            <a href="{{ url_for('home.beneficio_detail', beneficio_id=b.beneficios.id) }}" class="seguimiento-item">
                {{ b.beneficios.nombre }}
            </a>
        {% endfor %}
    {% else %}
        <div class="seguimiento-item sin">
            No tienes beneficios en seguimiento
        </div>
    {% endif %}
</div>


<!--Mostrar el menÃº desplegable del botÃ³n de perfil -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const perfilIcon = document.querySelector('.perfil-icon');
    const menu = document.getElementById('perfil-menu');

    perfilIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
        if (!perfilIcon.contains(e.target) && !menu.contains(e.target)) {
            menu.classList.remove('show');
        }
    });
});
</script>

<!-- LÃ³gica de Buscador -->
<script>
const inputBusqueda = document.getElementById("busquedaBeneficios");
const cajaResultados = document.getElementById("resultadosBusqueda");

let indiceSeleccionado = -1; // Para navegaciÃ³n con teclas
let resultadosActuales = []; // Ãšltimos resultados recibidos

// --- FunciÃ³n para renderizar resultados ---
function renderResultados() {
    if (resultadosActuales.length === 0) {
        cajaResultados.innerHTML = "<div class='resultado-sin'>Sin resultados</div>";
        cajaResultados.classList.add("show");
        return;
    }

    cajaResultados.innerHTML = resultadosActuales
        .map((b, i) => `
            <div 
                class="resultado-item ${i === indiceSeleccionado ? 'seleccionado' : ''}"
                data-index="${i}"
                onclick="window.location.href='/beneficio/${b.id}'"
            >
                <strong>${b.nombre}</strong><br>
            </div>
        `)
        .join("");

    cajaResultados.classList.add("show");
}

// --- BÃºsqueda dinÃ¡mica por input ---
inputBusqueda.addEventListener("input", function() {
    const texto = this.value.trim();
    indiceSeleccionado = -1;

    if (texto.length === 0) {
        cajaResultados.classList.remove("show");
        cajaResultados.innerHTML = "";
        return;
    }

    fetch(`/busqueda?q=${encodeURIComponent(texto)}`)
        .then(res => res.json())
        .then(data => {
            resultadosActuales = data;
            renderResultados();
        })
        .catch(err => console.error("Error:", err));
});

// --- NavegaciÃ³n con flechas ---
inputBusqueda.addEventListener("keydown", function(e) {
    if (!cajaResultados.classList.contains("show")) return;

    // Flecha abajo
    if (e.key === "ArrowDown") {
        e.preventDefault();
        if (indiceSeleccionado < resultadosActuales.length - 1) {
            indiceSeleccionado++;
            renderResultados();
        }
    }

    // Flecha arriba
    if (e.key === "ArrowUp") {
        e.preventDefault();
        if (indiceSeleccionado > 0) {
            indiceSeleccionado--;
            renderResultados();
        }
    }

    // Enter
    if (e.key === "Enter") {
        e.preventDefault();
        if (indiceSeleccionado >= 0 && resultadosActuales[indiceSeleccionado]) {
            const id = resultadosActuales[indiceSeleccionado].id;
            window.location.href = `/beneficio/${id}`;
        }
    }
});

// --- Cerrar dropdown al hacer clic fuera ---
document.addEventListener("click", function(e) {
    if (!cajaResultados.contains(e.target) && e.target !== inputBusqueda) {
        cajaResultados.classList.remove("show");
    }
});
</script>
<!--Mostrar el menÃº desplegable del botÃ³n de seguimiento-->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const seguimientoBtn = document.querySelector('.icon-btn[title="TrÃ¡mites"]');
    const seguimientoMenu = document.getElementById('seguimiento-menu');

    seguimientoBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        seguimientoMenu.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
        if (!seguimientoMenu.contains(e.target) && e.target !== seguimientoBtn) {
            seguimientoMenu.classList.remove('show');
        }
    });
});
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {

    const notifBtn = document.querySelector('.icon-btn[title="Notificaciones"]');
    const notifMenu = document.getElementById('notificaciones-menu');
    const lista = document.getElementById("lista-notificaciones");

    notifBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        notifMenu.classList.toggle('show');

        if (notifMenu.classList.contains('show')) {
            lista.innerHTML = `<div class="notificacion-item sin">Cargando...</div>`;

            const res = await fetch("/api/notificaciones");
            const data = await res.json();

            if (!data.length) {
                lista.innerHTML = `<div class="notificacion-item sin">No hay notificaciones</div>`;
                return;
            }

            lista.innerHTML = data.map(n => `
                <div class="notificacion-item ${n.leido ? 'leido' : 'no-leido'}">
                    <strong>${n.titulo}</strong><br>
                    <span>${n.mensaje}</span><br>
                    <small class="fecha">${n.fecha}</small>
                </div>
            `).join("");
        }
    });

    document.addEventListener('click', (e) => {
        if (!notifMenu.contains(e.target) && e.target !== notifBtn) {
            notifMenu.classList.remove('show');
        }
    });

});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const lista = document.getElementById("lista-notificaciones");
    const badge = document.getElementById("badge-notificaciones");

    function conectarBotones() {
        document.querySelectorAll(".btn-eliminar-notificacion").forEach(btn => {
            btn.onclick = async () => {
                const id = btn.dataset.id;

                const res = await fetch(`/notificaciones/eliminar/${id}`, {
                    method: "DELETE"
                });

                const data = await res.json();
                if (!data.success) return;

                // 1. Eliminar visualmente
                const item = document.querySelector(`.notificacion-item[data-id="${id}"]`);
                if (item) item.remove();

                // 2. Actualizar badge
                badge.textContent = data.restantes;

                // 3. Si no quedan notificaciones...
                if (data.restantes === 0) {
                    lista.innerHTML = `
                        <div class="notificaciones-item sin">
                            No tienes notificaciones.
                        </div>
                    `;
                }
            };
        });
    }

    conectarBotones();
});

</script>
