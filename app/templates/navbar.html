<link rel="stylesheet" href="{{ url_for('static', filename='navbar.css') }}">

<div class="navbar">
    <!-- Logo, lleva a la p치gina principal -->
    <a class="logo" href="{{ url_for('home.home') }}">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="MiTr치mite Logo" class="logo-img">
    </a>
    <!-- B칰squeda -->
    <div class="search-container">
        <input type="text" placeholder="Buscar Beneficio..." id="busquedaBeneficios" autocomplete="off">
            <div id="resultadosBusqueda" class="resultadosBusqueda"></div>
    </div>

    <!-- 칈conos -->
    <div class="icons">
        <button class="icon-btn perfil-icon" title="Perfil">游녻</button>
        {% if session.get('nombre') %}
        <button class="icon-btn" title="Notificaciones">游댒</button>
        <button class="icon-btn tracking-btn" title="Tr치mites">
            游늶
            {% if g.beneficios_usuario and g.beneficios_usuario|length > 0 %}
                <span class="badge">{{ g.beneficios_usuario|length }}</span>
            {% endif %}
        {% endif %}
        </button>
    </div>
</div>

<!-- Men칰 desplegable del perfil -->
 
<div id="perfil-menu" class="perfil-menu">
    {% if session.get('nombre') %}
    <div class="perfil-header">
        Bienvenido, <strong>{{ session.get('nombre', 'Usuario') }}</strong>
    </div>
    <a href="{{ url_for('auth.logout') }}">Cerrar sesi칩n</a>
    {% else %}
    <div class="perfil-header">
        춰Hola, <strong>Invitado!</strong>
    </div>
    <a href="{{ url_for('auth.printScreen') }}">춰Create una Cuenta!</a>
    {% endif %}
 
</div>

<!-- Men칰 desplegable de beneficios en seguimiento -->
<div id="seguimiento-menu" class="seguimiento-menu">
    <div class="seguimiento-header">
        <strong>En seguimiento</strong>
    </div>

    {% if g.beneficios_usuario and g.beneficios_usuario|length > 0 %}
        {% for b in g.beneficios_usuario %}
            <a href="{{ url_for('home.beneficio_detail', beneficio_id=b.beneficios.id) }}" class="seguimiento-item">
                {{ b.beneficios.nombre }}
            </a>
        {% endfor %}
    {% else %}
        <div class="seguimiento-item sin">
            No tienes beneficios en seguimiento
        </div>
    {% endif %}
</div>
<div id="lista-notificaciones" class="notificaciones-lista">
    <div class="notificacion-item sin">Cargando...</div>
    </div>
</div>

<!--Mostrar el men칰 desplegable del bot칩n de perfil -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const perfilIcon = document.querySelector('.perfil-icon');
    const menu = document.getElementById('perfil-menu');

    perfilIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
        if (!perfilIcon.contains(e.target) && !menu.contains(e.target)) {
            menu.classList.remove('show');
        }
    });
});
</script>

<!-- L칩gica de Buscador -->
<script>
const inputBusqueda = document.getElementById("busquedaBeneficios");
const cajaResultados = document.getElementById("resultadosBusqueda");

let indiceSeleccionado = -1; // Para navegaci칩n con teclas
let resultadosActuales = []; // 칔ltimos resultados recibidos

// --- Funci칩n para renderizar resultados ---
function renderResultados() {
    if (resultadosActuales.length === 0) {
        cajaResultados.innerHTML = "<div class='resultado-sin'>Sin resultados</div>";
        cajaResultados.classList.add("show");
        return;
    }

    cajaResultados.innerHTML = resultadosActuales
        .map((b, i) => `
            <div 
                class="resultado-item ${i === indiceSeleccionado ? 'seleccionado' : ''}"
                data-index="${i}"
                onclick="window.location.href='/beneficio/${b.id}'"
            >
                <strong>${b.nombre}</strong><br>
            </div>
        `)
        .join("");

    cajaResultados.classList.add("show");
}

// --- B칰squeda din치mica por input ---
inputBusqueda.addEventListener("input", function() {
    const texto = this.value.trim();
    indiceSeleccionado = -1;

    if (texto.length === 0) {
        cajaResultados.classList.remove("show");
        cajaResultados.innerHTML = "";
        return;
    }

    fetch(`/busqueda?q=${encodeURIComponent(texto)}`)
        .then(res => res.json())
        .then(data => {
            resultadosActuales = data;
            renderResultados();
        })
        .catch(err => console.error("Error:", err));
});

// --- Navegaci칩n con flechas ---
inputBusqueda.addEventListener("keydown", function(e) {
    if (!cajaResultados.classList.contains("show")) return;

    // Flecha abajo
    if (e.key === "ArrowDown") {
        e.preventDefault();
        if (indiceSeleccionado < resultadosActuales.length - 1) {
            indiceSeleccionado++;
            renderResultados();
        }
    }

    // Flecha arriba
    if (e.key === "ArrowUp") {
        e.preventDefault();
        if (indiceSeleccionado > 0) {
            indiceSeleccionado--;
            renderResultados();
        }
    }

    // Enter
    if (e.key === "Enter") {
        e.preventDefault();
        if (indiceSeleccionado >= 0 && resultadosActuales[indiceSeleccionado]) {
            const id = resultadosActuales[indiceSeleccionado].id;
            window.location.href = `/beneficio/${id}`;
        }
    }
});

// --- Cerrar dropdown al hacer clic fuera ---
document.addEventListener("click", function(e) {
    if (!cajaResultados.contains(e.target) && e.target !== inputBusqueda) {
        cajaResultados.classList.remove("show");
    }
});
</script>
<!--Mostrar el men칰 desplegable del bot칩n de seguimiento-->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const seguimientoBtn = document.querySelector('.icon-btn[title="Tr치mites"]');
    const seguimientoMenu = document.getElementById('seguimiento-menu');

    seguimientoBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        seguimientoMenu.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
        if (!seguimientoMenu.contains(e.target) && e.target !== seguimientoBtn) {
            seguimientoMenu.classList.remove('show');
        }
    });
});
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {

    const notifBtn = document.querySelector('.icon-btn[title="Notificaciones"]');
    const notifMenu = document.getElementById('notificaciones-menu');
    const lista = document.getElementById("lista-notificaciones");

    notifBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        notifMenu.classList.toggle('show');

        if (notifMenu.classList.contains('show')) {
            lista.innerHTML = `<div class="notificacion-item sin">Cargando...</div>`;

            const res = await fetch("/api/notificaciones");
            const data = await res.json();

            if (!data.length) {
                lista.innerHTML = `<div class="notificacion-item sin">No hay notificaciones</div>`;
                return;
            }

            lista.innerHTML = data.map(n => `
                <div class="notificacion-item ${n.leido ? 'leido' : 'no-leido'}">
                    <strong>${n.titulo}</strong><br>
                    <span>${n.mensaje}</span><br>
                    <small class="fecha">${n.fecha}</small>
                </div>
            `).join("");
        }
    });

    document.addEventListener('click', (e) => {
        if (!notifMenu.contains(e.target) && e.target !== notifBtn) {
            notifMenu.classList.remove('show');
        }
    });

});
</script>
